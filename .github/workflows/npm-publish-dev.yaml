
name: dev-ums
on:
  push:
    branches:
      - development

env:
  AWS_REGION: ap-south-1
  TAG: 0
  
jobs:
  semantic-release:
    name: semantic_release
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout branch "development"
        uses: actions/checkout@v2
        with:
          ref: "development"
          fetch-depth: 0

      # - name: semantic configuration
      #   run: |
      #     cat > release.config.js <<- "EOF"
      #       module.exports={"branches":["development"],
      #       "repositoryUrl":"https://github.com/byjus-orders/microservices-ums",
      #       "plugins":[
      #         "@semantic-release/commit-analyzer",
      #         "@semantic-release/release-notes-generator",
      #         "@semantic-release/github"]}
      - name: create a release
        run: |
          npm i -g semantic-release
          npm i -g @semantic-release/changelog
          npx semantic-release

          git config user.name "${{ secrets.GH_ADMIN_USERNAME }}"
          git config user.email "${{ secrets.GH_ADMIN_EMAIL }}"
          git remote set-url origin https://${{secrets.GH_ADMIN_USERNAME}}:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
          git add .
          git commit -m"changelog and package.json release[skip ci]
          git push
          imagetag=$(date +%Y-%m-%d-%H%M%S) 
          # checks tag is there or not, if not present picks the current timestamp
          if [ "${{env.TAG}}" != "" ]; then
           imagetag=${{env.TAG}}
          fi
          echo "image tag name  ${{imagetag}}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  deployment:
    if: always()
    needs:  semantic-release
    name: deployment
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: just logging
        run: |
            echo "working"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
